<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Clinical Profile Form</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#ec5b13",
                        background: "#0B1419",
                        card: "#16222a",
                        border: "#1E293B",
                        textPrimary: "#E6EDF3",
                        textSecondary: "#8FA3AD",
                        textMuted: "#6B7F89",
                        inputBg: "#1E2F36"
                    },
                    fontFamily: {
                        sans: ["Public Sans", "sans-serif"]
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0B1419;
            color: #E6EDF3;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .active-icon {
            font-variation-settings: 'FILL' 1;
        }

        /* Custom Input Styles */
        .clinic-input {
            background-color: #1E2F36;
            border: 1px solid #1E293B;
            color: #fdba74;
            border-radius: 8px;
            height: 44px;
            padding: 0 12px;
            width: 100%;
            transition: all 0.2s;
        }

        .clinic-input:focus {
            border-color: #ec5b13;
            outline: none;
            box-shadow: 0 0 0 1px rgba(236, 91, 19, 0.2);
        }

        .clinic-input::placeholder {
            color: #6B7F89;
        }

        /* Select Reset */
        select.clinic-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7F89' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col pb-24">
    <!-- Header -->
    <header
        class="sticky top-0 z-50 bg-[#0B1419]/90 backdrop-blur-md border-b border-[#1E293B] h-14 flex items-center justify-between px-4">
        <a href="dashboard.html"
            class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-[#16222a] transition text-slate-400">
            <span class="material-symbols-outlined text-[20px]">arrow_back</span>
        </a>
        <h1 class="text-base font-semibold tracking-tight text-[#E6EDF3]">Patient Profile</h1>
        <div class="w-9 h-9"></div>
    </header>

    <!-- Main Content Form -->
    <main class="flex-1 max-w-md mx-auto w-full px-4 py-6">
        <form id="profile-form" class="space-y-6">

            <!-- Section 1: Basic Information -->
            <section class="bg-card border border-border rounded-xl p-5 space-y-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-symbols-outlined text-primary text-[20px]">person</span>
                    <h2 class="text-sm font-bold uppercase tracking-wider text-textSecondary">Basic Information</h2>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-semibold text-textSecondary uppercase ml-1">Full Name</label>
                    <input type="text" id="p-name" class="clinic-input" placeholder="Enter full name" required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-textSecondary uppercase ml-1">Age</label>
                        <input type="number" id="p-age" class="clinic-input" placeholder="Years" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-textSecondary uppercase ml-1">Gender</label>
                        <select id="p-gender" class="clinic-input" required>
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Section 2: Body Metrics -->
            <section class="bg-card border border-border rounded-xl p-5 space-y-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-symbols-outlined text-primary text-[20px]">accessibility_new</span>
                    <h2 class="text-sm font-bold uppercase tracking-wider text-textSecondary">Body Metrics</h2>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-textSecondary uppercase ml-1">Height (cm)</label>
                        <input type="number" id="p-height" class="clinic-input" placeholder="cm" required
                            oninput="calculateBMI()">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-textSecondary uppercase ml-1">Weight (kg)</label>
                        <input type="number" id="p-weight" class="clinic-input" placeholder="kg" required
                            oninput="calculateBMI()">
                    </div>
                </div>

                <!-- BMI Auto-Display -->
                <div class="bg-[#1E293B] rounded-lg p-3 flex flex-col items-center justify-center transition-colors duration-300"
                    id="bmi-card">
                    <span class="text-[10px] font-bold uppercase tracking-widest text-textMuted mb-1">BMI
                        Calculation</span>
                    <div class="text-2xl font-bold text-textPrimary" id="bmi-value">--</div>
                    <div class="text-xs font-medium text-textSecondary mt-1" id="bmi-status">Enter metrics</div>
                </div>
            </section>

            <!-- Section 3: Prosthetic Information -->
            <section class="bg-card border border-border rounded-xl p-5 space-y-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-symbols-outlined text-primary text-[20px]">orthopedics</span>
                    <h2 class="text-sm font-bold uppercase tracking-wider text-textSecondary">Prosthetic Info</h2>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-semibold text-textSecondary uppercase ml-1">Amputation Level</label>
                    <select id="p-amputation" class="clinic-input" required>
                        <option value="">Select Level</option>
                        <option value="Transtibial">Transtibial (Below Knee)</option>
                        <option value="Transfemoral">Transfemoral (Above Knee)</option>
                        <option value="Knee Disarticulation">Knee Disarticulation</option>
                        <option value="Hip Disarticulation">Hip Disarticulation</option>
                    </select>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-semibold text-textSecondary uppercase ml-1">Device Type</label>
                    <input type="text" id="p-device" class="clinic-input" placeholder="e.g. Ottobock C-Leg" required>
                </div>
            </section>

            <!-- Submit Button -->
            <button type="submit" id="btn-save"
                class="w-full h-12 bg-primary hover:bg-[#d64a06] text-white font-bold rounded-xl active:scale-[0.98] transition-all disabled:opacity-60 disabled:cursor-not-allowed">
                Save Profile
            </button>

        </form>
    </main>

    <!-- Bottom Navigation -->
    <nav
        class="fixed bottom-0 left-0 right-0 bg-[#0B1419] border-t border-[#1E293B] h-16 flex items-center justify-around z-50">
        <a href="dashboard.html" class="flex flex-col items-center text-[#8FA3AD] hover:text-primary transition">
            <span class="material-symbols-outlined text-[22px]">dashboard</span>
            <span class="text-[11px] mt-1">Dashboard</span>
        </a>
        <a href="analytics.html" class="flex flex-col items-center text-[#8FA3AD] hover:text-primary transition">
            <span class="material-symbols-outlined text-[22px]">monitoring</span>
            <span class="text-[11px] mt-1">Analytics</span>
        </a>
        <a href="profile.html" class="flex flex-col items-center text-primary">
            <span class="material-symbols-outlined text-[22px] active-icon">person</span>
            <span class="text-[11px] font-semibold mt-1">Profile</span>
        </a>
        <a href="settings.html" class="flex flex-col items-center text-[#8FA3AD] hover:text-primary transition">
            <span class="material-symbols-outlined text-[22px]">settings</span>
            <span class="text-[11px] mt-1">Settings</span>
        </a>
    </nav>

    <script type="module">
        import { apiRequest } from './js/api.js';

        // BMI Logic
        window.calculateBMI = () => {
            const h = parseFloat(document.getElementById('p-height').value) / 100; // cm to m
            const w = parseFloat(document.getElementById('p-weight').value);
            const valEl = document.getElementById('bmi-value');
            const statusEl = document.getElementById('bmi-status');
            const cardEl = document.getElementById('bmi-card');

            if (h > 0 && w > 0) {
                const bmi = w / (h * h);
                valEl.textContent = bmi.toFixed(1);

                // Color Logic
                if (bmi < 18.5) {
                    statusEl.textContent = "Underweight";
                    valEl.style.color = "#3B82F6"; // Blue
                } else if (bmi < 25) {
                    statusEl.textContent = "Normal Weight";
                    valEl.style.color = "#22C55E"; // Green
                } else if (bmi < 30) {
                    statusEl.textContent = "Overweight";
                    valEl.style.color = "#EAB308"; // Yellow
                } else {
                    statusEl.textContent = "Obese";
                    valEl.style.color = "#EF4444"; // Red
                }
            } else {
                valEl.textContent = "--";
                statusEl.textContent = "Enter metrics";
                valEl.style.color = "#E6EDF3";
            }
        };

        // Load Data
        async function loadProfile() {
            try {
                // Fetch full profile from backend
                const data = await apiRequest('/patient/profile');

                if (data) {
                    document.getElementById('p-name').value = data.name || '';
                    document.getElementById('p-age').value = data.age || '';
                    document.getElementById('p-gender').value = data.gender || '';
                    document.getElementById('p-height').value = data.height_cm || '';
                    document.getElementById('p-weight').value = data.weight_kg || '';
                    document.getElementById('p-amputation').value = data.amputation_level || '';
                    document.getElementById('p-device').value = data.device_type || '';

                    calculateBMI();
                }
            } catch (e) {
                console.log("Profile not found or new user", e);
                // Try to pre-fill name/email from dashboard/token if profile fetch fails (e.g. 404)
                try {
                    const dash = await apiRequest('/patient/dashboard');
                    if (dash.patient_name) document.getElementById('p-name').value = dash.patient_name;
                } catch (dashArr) { }
            }
        }

        // Save Form
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            const originalText = btn.textContent;

            // 1. UI Loading State
            btn.textContent = "Saving...";
            btn.disabled = true;

            // 2. Get Email from Token
            let email = "user@example.com";
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const decoded = JSON.parse(atob(token.split('.')[1]));
                    email = decoded.sub; // 'sub' is usually email in our auth
                } catch (e) {
                    console.error("Token decode failed", e);
                }
            }

            // 3. Build Payload
            const payload = {
                name: document.getElementById('p-name').value,
                email: email,
                age: parseInt(document.getElementById('p-age').value),
                gender: document.getElementById('p-gender').value,
                height_cm: parseFloat(document.getElementById('p-height').value),
                weight_kg: parseFloat(document.getElementById('p-weight').value),
                amputation_level: document.getElementById('p-amputation').value,
                device_type: document.getElementById('p-device').value,
                // Include default medical values if creating fresh, to satisfy schema if required
                // Schema has optional now for these, but let's be safe if backend logic needs them
                // Actually schema has defaults for Optional, so we are good.
            };

            // 4. Send API Request
            try {
                // UPSERT via POST
                await apiRequest('/patient/profile', 'POST', payload);

                // Success Feedback
                btn.textContent = "Profile Saved";
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 1500);
            } catch (err) {
                console.error(err);
                btn.textContent = "Error Saving";
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 1500);
            }
        });

        loadProfile();
    </script>
</body>

</html>